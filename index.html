<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Programador de Horarios</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Fuente Inter de Tailwind */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para los inputs de número (ocultar flechas) */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        /* Estilos para Pestañas de Login */
        .tab-btn {
            @apply w-1/2 py-3 px-4 text-center font-medium border-b-4 cursor-pointer transition-colors duration-200;
        }
        .tab-btn-active {
            @apply border-blue-600 text-blue-600;
        }
        .tab-btn-inactive {
            @apply border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Contenedor de Login (MODIFICADO) -->
    <div id="login-container" class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md mx-auto">
        <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800 mb-6">
            Acceso al Sistema
        </h1>
        
        <!-- (NUEVO) Pestañas de Roles -->
        <div class="flex mb-5 border-b border-gray-200">
            <button id="supervisor-tab-btn" class="tab-btn tab-btn-active">
                Supervisor
            </button>
            <button id="assistant-tab-btn" class="tab-btn tab-btn-inactive">
                Auxiliar
            </button>
        </div>

        <!-- (NUEVO) Formulario de Supervisor -->
        <div id="supervisor-login-form">
            <div class="mb-4">
                <label for="login-supervisor-id" class="block text-sm font-medium text-gray-700 mb-2">
                    Número de Supervisor (6 dígitos)
                </label>
                <input type="number" id="login-supervisor-id" placeholder="Ej: 987654" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <div class="mb-6">
                <label for="login-password" class="block text-sm font-medium text-gray-700 mb-2">
                    Contraseña
                </label>
                <input type="password" id="login-password" placeholder="••••••••" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>

            <button id="login-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">
                Entrar
            </button>
        </div>

        <!-- (NUEVO) Formulario de Auxiliar -->
        <div id="assistant-login-form" class="hidden">
            <div class="mb-4">
                <label for="login-assistant-id" class="block text-sm font-medium text-gray-700 mb-2">
                    Número de Auxiliar (6 dígitos)
                </label>
                <input type="number" id="login-assistant-id" placeholder="Ej: 123456" class="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </div>
            
            <button id="assistant-login-btn" class="w-full bg-green-600 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200">
                Consultar Horario
            </button>
        </div>

        <div id="login-message-area" class="text-center mt-4 text-sm font-medium text-red-600"></div>
    </div>

    <!-- Contenedor del Programador (Supervisor) -->
    <div id="scheduler-container" class="hidden bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-2xl mx-auto">
        
        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6 gap-3 sm:gap-0">
            <h1 class="text-2xl sm:text-3xl font-bold text-center text-gray-800">
                Programador de Actividades
            </h1>
            <div class="text-center sm:text-right">
                <span id="supervisor-display" class="text-sm font-medium text-gray-700 block"></span>
                <button id="logout-btn-supervisor" class="text-sm text-red-600 hover:text-red-800 font-medium transition-colors">
                    Cerrar Sesión
                </button>
            </div>
        </div>

        <div class="mb-4">
            <label for="schedule-date" class="block text-sm font-medium text-gray-700 mb-2">
                Fecha a Programar
            </label>
            <input type="date" id="schedule-date" class="w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>

        <div class="mb-6">
            <label for="assistant-id" class="block text-sm font-medium text-gray-700 mb-2">
                Número de Auxiliar (Empleado a programar)
            </label>
            <div class="flex flex-col sm:flex-row gap-3">
                <input type="number" id="assistant-id" placeholder="Ej: 123456" class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <button id="load-schedule-btn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">
                    Cargar Horario
                </button>
            </div>
        </div>

        <div id="message-area" class="text-center my-4 text-sm font-medium"></div>

        <div id="schedule-grid" class="hidden">
            <h2 id="schedule-title" class="text-xl font-semibold text-gray-700 mb-5 text-center">
                Programar Empleado: 
            </h2>

            <div id="schedule-inputs-container" class="space-y-4 max-h-[40vh] overflow-y-auto pr-2">
                <!-- Las horas se generarán aquí con JavaScript -->
            </div>

            <div class="flex flex-col sm:flex-row gap-3 mt-6 border-t border-gray-200 pt-6">
                <button id="save-schedule-btn" class="w-full sm:w-1/2 bg-green-600 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200">
                    Guardar Horario
                </button>
                <button id="export-csv-btn" class="w-full sm:w-1/2 bg-gray-700 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:bg-gray-800 transition-colors duration-200">
                    Exportar a CSV (para Google Sheets)
                </button>
            </div>
        </div>

    </div>

    <!-- (NUEVO) Contenedor de Vista de Auxiliar -->
    <div id="assistant-view-container" class="hidden bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-lg mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">
                Mi Horario
            </h1>
            <div class="text-right">
                <span id="assistant-display" class="text-sm font-medium text-gray-700 block"></span>
                <button id="logout-btn-assistant" class="text-sm text-red-600 hover:text-red-800 font-medium transition-colors">
                    Cerrar Sesión
                </button>
            </div>
        </div>

        <div class="mb-4">
            <label for="assistant-schedule-date" class="block text-sm font-medium text-gray-700 mb-2">
                Seleccionar Fecha
            </label>
            <input type="date" id="assistant-schedule-date" class="w-full sm:w-auto px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>

        <button id="fetch-schedule-btn" class="w-full bg-green-600 text-white font-bold py-2 px-5 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200 mb-4">
            Consultar Horario
        </button>

        <div id="assistant-message-area" class="text-center my-4 text-sm font-medium"></div>

        <div id="assistant-schedule-display" class="space-y-3 mt-6 border-t border-gray-200 pt-6 max-h-[50vh] overflow-y-auto">
            <!-- El horario del auxiliar se mostrará aquí -->
        </div>
    </div>


    <!-- Custom Modal (Supervisor) -->
    <div id="next-assistant-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Horario Guardado</h3>
            <p class="text-sm text-gray-600 mb-6">¿Desea capturar el horario de otro auxiliar?</p>
            <div class="flex justify-end gap-3">
                <button id="modal-no-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400">
                    No
                </button>
                <button id="modal-yes-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Sí, capturar otro
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts de Firebase -->
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getFirestore, doc, getDoc, setDoc, setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- Variables Globales ---
        let db, auth, appId, userId, isAuthReady = false;
        let currentSupervisorId = null;
        let currentAssistantId = null; // Puede ser el programado O el que consulta
        let currentSelectedDate = null;
        let currentUserRole = 'supervisor'; // (NUEVO)
        
        // Configuración del horario
        const START_HOUR = 7;
        const END_HOUR = 17;
        const DB_COLLECTION_NAME = 'employeeSchedules';
        
        // --- Referencias del DOM ---
        // Vistas
        const loginContainer = document.getElementById('login-container');
        const schedulerContainer = document.getElementById('scheduler-container');
        const assistantViewContainer = document.getElementById('assistant-view-container'); // (NUEVO)

        // Login
        const supervisorTabBtn = document.getElementById('supervisor-tab-btn'); // (NUEVO)
        const assistantTabBtn = document.getElementById('assistant-tab-btn'); // (NUEVO)
        const supervisorLoginForm = document.getElementById('supervisor-login-form'); // (NUEVO)
        const assistantLoginForm = document.getElementById('assistant-login-form'); // (NUEVO)
        const loginSupervisorId = document.getElementById('login-supervisor-id');
        const loginPassword = document.getElementById('login-password');
        const loginAssistantId = document.getElementById('login-assistant-id'); // (NUEVO)
        const loginBtn = document.getElementById('login-btn');
        const assistantLoginBtn = document.getElementById('assistant-login-btn'); // (NUEVO)
        const loginMessageArea = document.getElementById('login-message-area');
        
        // Scheduler (Supervisor)
        const supervisorDisplay = document.getElementById('supervisor-display');
        const logoutBtnSupervisor = document.getElementById('logout-btn-supervisor');
        const assistantIdInput = document.getElementById('assistant-id');
        const loadScheduleBtn = document.getElementById('load-schedule-btn');
        const messageArea = document.getElementById('message-area');
        const scheduleGrid = document.getElementById('schedule-grid');
        const scheduleTitle = document.getElementById('schedule-title');
        const scheduleInputsContainer = document.getElementById('schedule-inputs-container');
        const saveScheduleBtn = document.getElementById('save-schedule-btn');
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const scheduleDateInput = document.getElementById('schedule-date');
        
        // Vista de Auxiliar (NUEVO)
        const assistantDisplay = document.getElementById('assistant-display');
        const logoutBtnAssistant = document.getElementById('logout-btn-assistant');
        const assistantScheduleDate = document.getElementById('assistant-schedule-date');
        const fetchScheduleBtn = document.getElementById('fetch-schedule-btn');
        const assistantMessageArea = document.getElementById('assistant-message-area');
        const assistantScheduleDisplay = document.getElementById('assistant-schedule-display');

        // Modal (Supervisor)
        const nextAssistantModal = document.getElementById('next-assistant-modal');
        const modalNoBtn = document.getElementById('modal-no-btn');
        const modalYesBtn = document.getElementById('modal-yes-btn');

        // --- Funciones Principales ---

        function getTodayDateString() {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const day = today.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function showMessage(text, type = 'info') {
            messageArea.textContent = text;
            if (type === 'success') {
                messageArea.className = 'text-center my-4 text-sm font-medium text-green-600';
            } else if (type === 'error') {
                messageArea.className = 'text-center my-4 text-sm font-medium text-red-600';
            } else {
                messageArea.className = 'text-center my-4 text-sm font-medium text-gray-600';
            }
        }
        
        // (NUEVO) Mensajes para la vista de auxiliar
        function showAssistantMessage(text, type = 'info') {
            assistantMessageArea.textContent = text;
            if (type === 'success') {
                assistantMessageArea.className = 'text-center my-4 text-sm font-medium text-green-600';
            } else if (type === 'error') {
                assistantMessageArea.className = 'text-center my-4 text-sm font-medium text-red-600';
            } else {
                assistantMessageArea.className = 'text-center my-4 text-sm font-medium text-gray-600';
            }
        }

        // Valida el ID del Auxiliar (para Supervisor)
        function getValidAssistantId() {
            const assistantId = assistantIdInput.value;
            
            if (!currentSupervisorId) {
                showMessage("Error: No hay un supervisor activo. Por favor, inicie sesión de nuevo.", 'error');
                return null;
            }

            if (!/^\d{6}$/.test(assistantId)) {
                showMessage("El número de AUXILIAR debe ser de 6 dígitos.", 'error');
                assistantIdInput.focus();
                scheduleGrid.classList.add('hidden');
                return null;
            }
            return assistantId;
        }

        function generateScheduleUI() {
            scheduleInputsContainer.innerHTML = ''; // Limpiar
            for (let hour = START_HOUR; hour <= END_HOUR; hour++) {
                const hourLabel = `${hour.toString().padStart(2, '0')}:00 - ${(hour + 1).toString().padStart(2, '0')}:00`;
                
                const row = document.createElement('div');
                row.className = 'grid grid-cols-[1fr_auto] sm:grid-cols-[1fr_100px] gap-3 items-center';

                const label = document.createElement('label');
                label.htmlFor = `hour-${hour}`;
                label.textContent = hourLabel;
                label.className = 'font-medium text-gray-600 text-sm sm:text-base';
                
                const input = document.createElement('input');
                input.type = 'number';
                input.id = `hour-${hour}`;
                input.dataset.hour = hour;
                input.min = 1;
                input.max = 70;
                input.placeholder = "Pasillo";
                input.className = 'w-full px-3 py-1.5 border border-gray-300 rounded-md shadow-sm text-center focus:outline-none focus:ring-1 focus:ring-blue-500';
                
                row.appendChild(label);
                row.appendChild(input);
                scheduleInputsContainer.appendChild(row);
            }
        }

        // --- Lógica del Supervisor ---

        async function loadSchedule() {
            const assistantId = getValidAssistantId();
            if (!assistantId) return;

            const selectedDate = scheduleDateInput.value;
            if (!selectedDate) {
                showMessage("Por favor, seleccione una fecha.", 'error');
                return;
            }

            // Guardar los IDs y fecha válidos
            currentAssistantId = assistantId; // Auxiliar a programar
            currentSelectedDate = selectedDate;

            if (!isAuthReady || !db) {
                showMessage("Conectando a la base de datos... por favor intente de nuevo.", 'error');
                return;
            }
            
            showMessage("Cargando horario...", 'info');
            
            try {
                const documentId = `${currentAssistantId}_${currentSelectedDate}`;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', DB_COLLECTION_NAME, documentId);
                const docSnap = await getDoc(docRef);

                const scheduleData = docSnap.exists() ? docSnap.data().schedule : {};

                // Poblar los inputs
                for (let hour = START_HOUR; hour <= END_HOUR; hour++) {
                    const input = document.getElementById(`hour-${hour}`);
                    if (input) {
                        input.value = scheduleData[hour] || '';
                    }
                }
                
                scheduleTitle.textContent = `Programar Auxiliar: ${currentAssistantId} (Fecha: ${currentSelectedDate})`;
                scheduleGrid.classList.remove('hidden');
                showMessage("Horario cargado. Puede editar y guardar.", 'success');

            } catch (error) {
                console.error("Error al cargar datos: ", error);
                showMessage("Error al cargar el horario. Revise la consola.", 'error');
            }
        }
        
        async function saveSchedule() {
            if (!currentSupervisorId || !currentAssistantId || !currentSelectedDate) {
                 showMessage("Error: No se ha cargado ningún auxiliar o fecha. Cargue uno primero.", 'error');
                 return;
            }

            if (!isAuthReady || !db) {
                showMessage("Error de conexión. No se puede guardar.", 'error');
                return;
            }

            showMessage("Guardando...", 'info');

            const scheduleData = {};
            for (let hour = START_HOUR; hour <= END_HOUR; hour++) {
                const input = document.getElementById(`hour-${hour}`);
                const valueStr = input.value;
                
                if (valueStr) {
                    const aisle = parseInt(valueStr, 10);
                    if (!isNaN(aisle) && aisle >= 1 && aisle <= 70) {
                        scheduleData[hour] = aisle;
                    } else if (aisle > 70 || aisle < 1) {
                        showMessage(`Error: El pasillo para las ${hour}:00 debe estar entre 1 y 70.`, 'error');
                        input.focus();
                        return;
                    } else {
                        scheduleData[hour] = null;
                    }
                } else {
                    scheduleData[hour] = null;
                }
            }

            try {
                const documentId = `${currentAssistantId}_${currentSelectedDate}`;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', DB_COLLECTION_NAME, documentId);
                await setDoc(docRef, { 
                    schedule: scheduleData,
                    lastUpdated: new Date().toISOString(),
                    lastUpdatedBy: currentSupervisorId
                });
                
                // --- Enviar datos a Google Apps Script ---
                try {
                    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxTKppwPZjkTDeCwVYTtk5OUd8VNeo2wh5GyWeGK6ANLtXnKOfK-4GNDjsIMR7CjI9i/exec'; 

                    const dataToPost = {
                        date: currentSelectedDate,
                        supervisorId: currentSupervisorId,
                        assistantId: currentAssistantId,
                        schedule: scheduleData
                    };

                    const response = await fetch(APPS_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        cache: 'no-cache',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(dataToPost)
                    });
                    
                    console.log("Datos enviados a Google Apps Script.");
                } catch (e) {
                    console.warn("Error al enviar datos a Google Apps Script:", e);
                }
                // --- Fin de la sección de Apps Script ---

                nextAssistantModal.classList.remove('hidden');

            } catch (error) {
                console.error("Error al guardar datos: ", error);
                showMessage("Error al guardar el horario. Revise la consola.", 'error');
            }
        }

        function exportToCSV() {
            if (!currentAssistantId || !currentSelectedDate) {
                showMessage("Cargue un auxiliar y seleccione una fecha primero para exportar.", 'error');
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Fecha,Empleado,Hora,Pasillo\n";

            for (let hour = START_HOUR; hour <= END_HOUR; hour++) {
                const hourLabel = `${hour.toString().padStart(2, '0')}:00 - ${(hour + 1).toString().padStart(2, '0')}:00`;
                const input = document.getElementById(`hour-${hour}`);
                const aisle = input.value || 'N/A';
                
                csvContent += `"${currentSelectedDate}","${currentAssistantId}","${hourLabel}","${aisle}"\n`;
            }
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `horario_auxiliar_${currentAssistantId}_${currentSelectedDate}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showMessage("Exportación CSV generada.", 'info');
        }

        // --- Lógica del Auxiliar (NUEVA) ---

        async function fetchAssistantSchedule() {
            // El ID del auxiliar ya está en currentAssistantId desde el login
            const selectedDate = assistantScheduleDate.value;
            if (!selectedDate) {
                showAssistantMessage("Por favor, seleccione una fecha.", 'error');
                return;
            }

            if (!isAuthReady || !db) {
                showAssistantMessage("Conectando a la base de datos... por favor intente de nuevo.", 'error');
                return;
            }

            showAssistantMessage("Buscando horario...", 'info');
            assistantScheduleDisplay.innerHTML = ''; // Limpiar resultados

            try {
                const documentId = `${currentAssistantId}_${selectedDate}`;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', DB_COLLECTION_NAME, documentId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const scheduleData = docSnap.data().schedule;
                    let entriesFound = 0;

                    const title = document.createElement('h3');
                    title.className = "text-lg font-semibold text-gray-800 mb-3";
                    title.textContent = `Horario para el día: ${selectedDate}`;
                    assistantScheduleDisplay.appendChild(title);

                    for (let hour = START_HOUR; hour <= END_HOUR; hour++) {
                        const aisle = scheduleData[hour];
                        if (aisle) {
                            const hourLabel = `${hour.toString().padStart(2, '0')}:00 - ${(hour + 1).toString().padStart(2, '0')}:00`;
                            const p = document.createElement('p');
                            p.className = "text-gray-700 bg-gray-50 p-3 rounded-md";
                            p.innerHTML = `<strong class="text-gray-900">${hourLabel}:</strong> Pasillo ${aisle}`;
                            assistantScheduleDisplay.appendChild(p);
                            entriesFound++;
                        }
                    }

                    if (entriesFound === 0) {
                        showAssistantMessage("No hay pasillos asignados para este día.", 'info');
                    } else {
                        showAssistantMessage(`Horario cargado. Tienes ${entriesFound} asignaciones.`, 'success');
                    }
                } else {
                    showAssistantMessage("No se encontró ningún horario programado para este día.", 'info');
                    assistantScheduleDisplay.innerHTML = '';
                }
            } catch (error) {
                console.error("Error al cargar horario de auxiliar: ", error);
                showAssistantMessage("Error al consultar el horario. Revise la consola.", 'error');
            }
        }


        // --- Configuración General y Autenticación ---

        async function setupFirebase() {
            try {
                const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
                const firebaseConfig = JSON.parse(firebaseConfigStr);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                setLogLevel('Debug');

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        console.log("Usuario autenticado:", user.uid);
                        userId = user.uid;
                        isAuthReady = true;
                    } else {
                        console.log("Usuario no autenticado.");
                        isAuthReady = false;
                    }
                });

                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    await signInWithCustomToken(auth, token);
                } else {
                    await signInAnonymously(auth);
                }

            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                loginMessageArea.textContent = "Error al conectar con la base de datos.";
            }
        }
        
        // (MODIFICADO) Lógica de Autenticación
        
        function handleSupervisorLogin() {
            const id = loginSupervisorId.value;
            const pass = loginPassword.value;

            if (!/^\d{6}$/.test(id)) {
                loginMessageArea.textContent = "El número de supervisor debe ser de 6 dígitos.";
                return;
            }

            const DEMO_PASSWORD = "admin123";

            if (pass === DEMO_PASSWORD) {
                currentSupervisorId = id;
                supervisorDisplay.textContent = `Supervisor: ${id}`;
                
                loginContainer.classList.add('hidden');
                schedulerContainer.classList.remove('hidden');
                
                loginMessageArea.textContent = "";
                loginPassword.value = "";
                
            } else {
                loginMessageArea.textContent = "Contraseña incorrecta.";
            }
        }

        // (NUEVO) Login para Auxiliar
        function handleAssistantLogin() {
            const id = loginAssistantId.value;
            if (!/^\d{6}$/.test(id)) {
                loginMessageArea.textContent = "El número de auxiliar debe ser de 6 dígitos.";
                return;
            }

            // Aquí podríamos validar si el auxiliar existe, 
            // pero por simplicidad, solo le damos acceso a la vista.
            currentAssistantId = id;
            assistantDisplay.textContent = `Auxiliar: ${id}`;

            loginContainer.classList.add('hidden');
            assistantViewContainer.classList.remove('hidden');

            loginMessageArea.textContent = "";
            loginAssistantId.value = "";
        }

        function handleLogout() {
            currentSupervisorId = null;
            currentAssistantId = null;
            currentSelectedDate = null;
            currentUserRole = 'supervisor'; // Resetear al rol por defecto

            // Ocultar todas las vistas de contenido
            schedulerContainer.classList.add('hidden');
            assistantViewContainer.classList.add('hidden'); // (NUEVO)
            scheduleGrid.classList.add('hidden');
            
            // Limpiar formularios y mensajes
            showMessage('', 'info');
            showAssistantMessage('', 'info'); // (NUEVO)
            assistantIdInput.value = '';
            assistantScheduleDisplay.innerHTML = ''; // (NUEVO)

            // Resetear fechas a hoy
            scheduleDateInput.value = getTodayDateString();
            assistantScheduleDate.value = getTodayDateString(); // (NUEVO)

            // Mostrar el contenedor de login
            loginContainer.classList.remove('hidden');
            loginSupervisorId.value = '';
            loginAssistantId.value = ''; // (NUEVO)
            loginPassword.value = '';
            
            // (NUEVO) Resetear pestañas de login
            supervisorTabBtn.click();
        }
        
        // (NUEVO) Cambiar pestañas de Login
        function switchLoginTab(role) {
            currentUserRole = role;
            loginMessageArea.textContent = '';
            
            if (role === 'supervisor') {
                supervisorTabBtn.classList.add('tab-btn-active');
                supervisorTabBtn.classList.remove('tab-btn-inactive');
                assistantTabBtn.classList.add('tab-btn-inactive');
                assistantTabBtn.classList.remove('tab-btn-active');
                
                supervisorLoginForm.classList.remove('hidden');
                assistantLoginForm.classList.add('hidden');
            } else {
                assistantTabBtn.classList.add('tab-btn-active');
                assistantTabBtn.classList.remove('tab-btn-inactive');
                supervisorTabBtn.classList.add('tab-btn-inactive');
                supervisorTabBtn.classList.remove('tab-btn-active');

                assistantLoginForm.classList.remove('hidden');
                supervisorLoginForm.classList.add('hidden');
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            setupFirebase();
            generateScheduleUI();
            
            // Poner la fecha de hoy por defecto en ambos selectores
            scheduleDateInput.value = getTodayDateString();
            assistantScheduleDate.value = getTodayDateString(); // (NUEVO)

            // (NUEVO) Listeners de pestañas de Login
            supervisorTabBtn.addEventListener('click', () => switchLoginTab('supervisor'));
            assistantTabBtn.addEventListener('click', () => switchLoginTab('assistant'));

            // Listener para cambio de fecha (Supervisor)
            scheduleDateInput.addEventListener('change', () => {
                const newDate = scheduleDateInput.value;
                if (newDate !== currentSelectedDate) {
                    currentSelectedDate = newDate;
                    if (!scheduleGrid.classList.contains('hidden')) {
                        scheduleGrid.classList.add('hidden');
                        showMessage("Fecha cambiada. Vuelva a cargar el horario del auxiliar para este día.", 'info');
                        currentAssistantId = null;
                        assistantIdInput.value = '';
                        assistantIdInput.focus();
                    }
                }
            });

            // Listeners del Programador (Supervisor)
            loadScheduleBtn.addEventListener('click', loadSchedule);
            saveScheduleBtn.addEventListener('click', saveSchedule);
            exportCsvBtn.addEventListener('click', exportToCSV);

            // Listeners de Login/Logout
            loginBtn.addEventListener('click', handleSupervisorLogin); // (MODIFICADO)
            assistantLoginBtn.addEventListener('click', handleAssistantLogin); // (NUEVO)
            logoutBtnSupervisor.addEventListener('click', handleLogout);
            logoutBtnAssistant.addEventListener('click', handleLogout); // (NUEVO)
            
            // (NUEVO) Listener para vista de Auxiliar
            fetchScheduleBtn.addEventListener('click', fetchAssistantSchedule);

            // Listeners para modal (Supervisor)
            modalNoBtn.addEventListener('click', () => {
                nextAssistantModal.classList.add('hidden');
                handleLogout();
            });

            modalYesBtn.addEventListener('click', () => {
                nextAssistantModal.classList.add('hidden');
                assistantIdInput.value = '';
                scheduleGrid.classList.add('hidden');
                showMessage('Ingrese el siguiente número de auxiliar.', 'info');
                currentAssistantId = null;
                assistantIdInput.focus();
            });

            // Permitir presionar Enter para login (Supervisor)
            loginPassword.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSupervisorLogin();
            });
            loginSupervisorId.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loginPassword.focus();
            });
            
            // (NUEVO) Permitir presionar Enter para login (Auxiliar)
            loginAssistantId.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleAssistantLogin();
            });

            // Permitir presionar Enter para cargar (Supervisor)
            assistantIdInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') loadSchedule();
            });
        });
    </script>
</body>
</html>

